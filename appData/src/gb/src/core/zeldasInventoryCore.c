#include <gb/gb.h>
#include "zeldasInventoryCore.h"

// custom tilesets and tilemaps for the inventory screen
// -----------------------------------------------------
const unsigned char staticTileset[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xC3,0xC3,0xBD,0xBD,0xBD,0xBD,0x7D,0x7D,0x63,0x63,0x7B,0x7B,0x85,0x85,0xFF,0xFF,
0xDD,0xDD,0xDD,0xDD,0xBB,0xBB,0xBB,0xBB,0x77,0x77,0x77,0x77,0x8F,0x8F,0xFF,0xFF,
0xC1,0xC1,0xDF,0xDF,0xDF,0xDF,0x83,0x83,0xBF,0xBF,0x7F,0x7F,0x03,0x03,0xFF,0xFF,
0xC3,0xC3,0xBD,0xBD,0xBF,0xBF,0xC7,0xC7,0xFB,0xFB,0x7B,0x7B,0x87,0x87,0xFF,0xFF,
0x81,0x81,0xEF,0xEF,0xEF,0xEF,0xDF,0xDF,0xDF,0xDF,0xBF,0xBF,0xBF,0xBF,0xFF,0xFF,
0xFD,0xFD,0xF9,0xF9,0xF5,0xF5,0xED,0xED,0xC1,0xC1,0xBD,0xBD,0x7D,0x7D,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0x00,0x00,0x72,0x72,0x8A,0x8A,0x8A,0x8A,0x8A,0x8A,0xAA,0xAA,0x92,0x92,0x69,0x69,
0x00,0x00,0x2E,0x2E,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0x24,0xCE,0xCE,
0x00,0x00,0xF8,0xF8,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x00,0x00,0x71,0x71,0x8A,0x8A,0x82,0x82,0x73,0x73,0x0A,0x0A,0x8A,0x8A,0x72,0x72,
0x00,0x00,0xC8,0xC8,0x28,0x28,0x28,0x28,0xE8,0xE8,0x25,0x25,0x25,0x25,0x22,0x22,
0x00,0x00,0xBE,0xBE,0xA0,0xA0,0xA0,0xA0,0xBC,0xBC,0x20,0x20,0x20,0x20,0x3E,0x3E,
0xC3,0xC3,0xDD,0xDD,0xBD,0xBD,0x83,0x83,0xB7,0xB7,0x77,0x77,0x77,0x77,0xFF,0xFF,
0xBD,0xBD,0xBD,0xBD,0xBB,0xBB,0x6B,0x6B,0x4B,0x4B,0x27,0x27,0x77,0x77,0xFF,0xFF,
0xC3,0xC3,0xDD,0xDD,0xBD,0xBD,0x83,0x83,0xBF,0xBF,0x7F,0x7F,0x7F,0x7F,0xFF,0xFF,
0xC3,0xC3,0xBD,0xBD,0xBD,0xBD,0x7D,0x7D,0x7B,0x7B,0x7B,0x7B,0x87,0x87,0xFF,0xFF,
0xDD,0xDD,0xDD,0xDD,0x8D,0x8D,0xAB,0xAB,0xB3,0xB3,0x7B,0x7B,0x7B,0x7B,0xFF,0xFF,
0xF7,0xF7,0xF3,0xF3,0x81,0x81,0x80,0x80,0x81,0x81,0xF3,0xF3,0xF7,0xF7,0xFF,0xFF,
0xF7,0xF7,0xE7,0xE7,0xC0,0xC0,0x80,0x80,0xC0,0xC0,0xE7,0xE7,0xF7,0xF7,0xFF,0xFF,
0x00,0x00,0x00,0x00,0x1C,0x1C,0x3E,0x22,0x71,0x4F,0x60,0x5F,0x60,0x5F,0x40,0x7F,
0x00,0x00,0x00,0x00,0x38,0x38,0x7C,0x44,0x8E,0xF2,0x06,0xFA,0x06,0xFA,0x02,0xFE,
0x20,0x3F,0x10,0x1F,0x08,0x0F,0x04,0x07,0x02,0x03,0x01,0x01,0x00,0x00,0x00,0x00,
0x04,0xFC,0x08,0xF8,0x10,0xF0,0x20,0xE0,0x40,0xC0,0x80,0x80,0x00,0x00,0x00,0x00
};

// All tile references offset by 194 (0xc2), the number of inventory tiles
const unsigned char questStatusMap[] = {
0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,
0xc3,0xc3,0xc3,0xc3,0xc4,0xc5,0xc6,0xc7,0xc8,0xc3,0xc7,0xc8,0xc9,0xc8,0xc5,0xc7,0xc3,0xc3,0xc3,0xc3, // quest status
0xc3,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xca,0xc3, // dotted lines
0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,
0xc3,0xc2,0xcb,0xcc,0xcd,0xc2,0xc2,0xc2,0xc2,0xc3,0xc3,0xc2,0xc2,0xc2,0xc2,0xce,0xcf,0xd0,0xc2,0xc3, // quit save
0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,0xd8,0xd9,0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,
0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,0xda,0xdb,0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,
0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,
0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,
0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,
0xc3,0xc3,0xc3,0xc3,0xc3,0xc8,0xd1,0xc6,0xc9,0xc7,0xc5,0xd1,0xc6,0xc7,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3, // treasures
0xc3,0xc3,0xc3,0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,0xc3,0xc3,0xc3,
0xc3,0xc3,0xd7,0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,0xd6,0xc3,0xc3,
0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,
0xc3,0xc3,0xc3,0xc3,0xc3,0xd2,0xc6,0xc9,0xd3,0xd4,0xd5,0xc7,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3, // weapons
0xc3,0xc3,0xc3,0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,0xc3,0xc3,0xc3,
0xc3,0xc3,0xd7,0xc3,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc2,0xc3,0xd6,0xc3,0xc3,
0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,
};

// pointer to GB Studio variables $06 - $12
UINT16 *_inventoryInteraction = (UINT16 *)0xcb2b;
UINT16 *_inventoryFlags1 = (UINT16 *)0xcb2d;
UINT16 *_inventoryFlags2 = (UINT16 *)0xcb2f;
UINT16 *_inventoryFlags3 = (UINT16 *)0xcb31;
UINT16 *_inventoryFlags4 = (UINT16 *)0xcb33;
UINT16 *_weaponEquipped = (UINT16 *)0xcb35;
UINT8 *_highlighted = (UINT8 *)0xcb37;  // if the equipped treasure is visible this is set to 1-6
UINT16 *_overworldFlags = (UINT8 *)0xcb39;

const UINT8 maxItemsOnScreen = 6;
UINT8 totalWeaponsFound = 19;
UINT8 slot = 0;
UINT8 weaponScrollOffset = 0;
const UINT8 totalWeaponsAvailable = 19;
ZELDA_WEAPONS weaponEquipped = ZELDA_WEAPON_UNDEFINED; // interrogates *_weaponEquipped to evaluate value                         
ZELDA_WEAPONS weapons[19];
unsigned char firstTile = 0x00;

// on screen view of weapons
unsigned char weaponPanel[] = {0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2,
                               0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2,};

UBYTE GetBit(UINT16 byte, UINT8 bit)
{
    return (byte & (1 << bit)) != 0;
}

void IdentifyWeaponsFound()
{
    // populate weapons array by interrogate GB Studio
    totalWeaponsFound = 0;
    if(GetBit(*_inventoryFlags1, 0)) {
        weapons[totalWeaponsFound] = ZELDA_WEAPON_WAND;
        totalWeaponsFound++;
    }
    if(GetBit(*_inventoryFlags1, 9)) {
        weapons[totalWeaponsFound] = ZELDA_WEAPON_JADEAMULET;
        totalWeaponsFound++;
    }
}

void IdentifyEquipped()
{
    switch(*_weaponEquipped)
    {
        case 1:
            weaponEquipped = ZELDA_WEAPON_WAND;
            break;
        case 10:
            weaponEquipped = ZELDA_WEAPON_JADEAMULET;
            break;
        
    }
}

void DrawWeapons()
{
    // add weapons to on screen weaponPanel
    slot = 0;
    for (UINT8 i = weaponScrollOffset; i < maxItemsOnScreen + weaponScrollOffset; i++)
    {
        for (UINT8 j = 1; j <= totalWeaponsAvailable; j++)
        {
            if (weapons[i] == j) {
                weaponPanel[slot] = firstTile + ((j-1) * 4);
                weaponPanel[slot + 1] = firstTile + ((j-1) * 4) + 1;
                weaponPanel[slot + 12] = firstTile + ((j-1) * 4) + 2;
                weaponPanel[slot + 13] = firstTile + ((j-1) * 4) + 3;
                slot += 2;
                if (weaponEquipped == j) 
                {
                    *_highlighted = i - weaponScrollOffset + 1;
                }
                continue;
            }
        }
    }

    set_bkg_tiles(4, 15, 12, 2, weaponPanel);    
}

UBYTE CanScrollWeaponsRight()
{
    return weaponScrollOffset < totalWeaponsFound - maxItemsOnScreen;
}

void ScrollWeaponsRight()
{
    if (CanScrollWeaponsRight())
    {
        weaponScrollOffset++;
        DrawWeapons();
    }
}

UBYTE CanScrollWeaponsLeft()
{
    return weaponScrollOffset > 0;
}

void ScrollWeaponsLeft()
{
    if (CanScrollWeaponsLeft())
    {
        weaponScrollOffset--;
        DrawWeapons();
    }
}

void SelectWeapon(UINT8 weaponSlot) 
{
    *_weaponEquipped = weapons[weaponSlot + weaponScrollOffset];
}

void DrawCelestialSignIndicator()
{
    unsigned char celestialPanel[16] = {0xc2,0xc3,0xc3,0xc2,
                                        0xc3,0xd8,0xd9,0xc3,
                                        0xc3,0xda,0xdb,0xc3,
                                        0xc2,0xc3,0xc3,0xc2
                                        };
    // draw a 0
    celestialPanel[1] = firstTile + 181;
    
    // draw a 1
    if (GetBit(*_overworldFlags, 0)) celestialPanel[2] = firstTile + 182;
    // draw a 2
    if (GetBit(*_overworldFlags, 1)) celestialPanel[7] = firstTile + 183;
    // draw a 3
    if (GetBit(*_overworldFlags, 2)) celestialPanel[11] = firstTile + 184;
    // draw a 4
    if (GetBit(*_overworldFlags, 3)) celestialPanel[14] = firstTile + 185;
    // draw a 5
    if (GetBit(*_overworldFlags, 4)) celestialPanel[13] = firstTile + 186;
    // draw a 6
    if (GetBit(*_overworldFlags, 5)) celestialPanel[8] = firstTile + 187;
    // draw a 7
    if (GetBit(*_overworldFlags, 6)) celestialPanel[4] = firstTile + 188;

    set_bkg_tiles(8, 4, 4, 4, celestialPanel);
}

void InitZeldaInventory() 
{
    // load the core tiles that won't change (22 tiles)
    // data starts at 194 to account for inventory item tiles
    set_bkg_data(194, 26, staticTileset);

    // draw the background tiles
    set_bkg_tiles(0, 0, 20, 18, questStatusMap);

    // write 1-7 depending on dungeons complete
    DrawCelestialSignIndicator();

    // initialise the weapon tiles
    IdentifyWeaponsFound();
    IdentifyEquipped();
    DrawWeapons();
}

void CheckForInventoryInteraction() 
{
    if (*_inventoryInteraction != 0) {
        switch (*_inventoryInteraction) 
        {
            case 1:
                *_inventoryInteraction = 0;
                ScrollWeaponsLeft();
                break;
            case 2:
                *_inventoryInteraction = 0;
                ScrollWeaponsRight();
                break;
            case 3:
                *_inventoryInteraction = 0;
                SelectWeapon(0);
                break;
            case 4:
                *_inventoryInteraction = 0;
                SelectWeapon(1);
                break;
        }
    }
    
}
